{% extends "base.html" %}
{% block title %}{{ content.title }} - EduMate{% endblock %}

{% block content %}
<style>
.rating-star {
    cursor: pointer;
    color: #ddd;
    transition: color 0.2s;
}

.rating-star:hover,
.rating-star.active {
    color: #ffc107;
}

.rating-label {
    cursor: pointer;
}

.rating-label:hover .rating-star {
    color: #ffc107;
}

.quick-action-btn {
    min-width: 120px;
    margin: 5px;
}

.quick-actions-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
}

.custom-notification {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.content-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.content-body {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    margin-bottom: 2rem;
}

.stats-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    margin-bottom: 1.5rem;
}

/* Rating summary card */
.rating-summary-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    padding: 1rem 1.5rem;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.rating-score {
    font-size: 2.5rem;
    font-weight: bold;
    line-height: 1;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.rating-stars {
    margin-top: 0.5rem;
}

.rating-count {
    font-size: 1.5rem;
    font-weight: 600;
    color: white;
}

/* Rating widget */
.rating-widget {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid #e9ecef;
}

.user-rating-display {
    font-size: 0.9rem;
}

.rating-stars-large {
    display: flex;
    gap: 4px;
}

.compact-rating-star {
    font-size: 1.8rem !important;
    color: #ddd;
    cursor: pointer;
    transition: all 0.2s ease;
    margin: 0 2px !important;
    padding: 4px;
    border-radius: 4px;
}

.compact-rating-star:hover {
    color: #ffc107 !important;
    transform: scale(1.15);
    background-color: rgba(255, 193, 7, 0.1);
}

.compact-rating-star.active {
    color: #ffc107 !important;
}

.compact-rating-star:active {
    transform: scale(0.95);
    background-color: rgba(255, 193, 7, 0.2);
}

.rating-hint {
    font-size: 0.85rem;
    font-weight: 500;
    transition: color 0.2s ease;
    text-align: center;
    padding: 4px 8px;
    border-radius: 12px;
    background-color: rgba(0, 0, 0, 0.05);
    display: inline-block;
}

.rating-form-group {
    margin-top: 1rem;
}

.rating-comment-box {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 0.9rem;
    resize: vertical;
    min-height: 60px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.rating-comment-box:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.rating-actions {
    margin-top: 1rem;
    text-align: right;
}

.rating-submit-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 0.5rem 1.5rem;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.rating-submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.rating-submit-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

.content-preview {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1rem;
    margin: 1rem 0;
}

.meta-badge {
    background: rgba(255,255,255,0.2);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    margin: 0.25rem;
}

.stats-item {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 10px;
}

.stats-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    color: white;
}

.tab-content {
    margin-top: 1rem;
}

.feedback-item {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
    border-left: 4px solid #667eea;
}

.quick-action-card {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.btn-custom {
    border-radius: 25px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.btn-custom:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.pdf-viewer {
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.video-container {
    position: relative;
    padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
    height: 0;
    overflow: hidden;
}

.video-container video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
}

/* Delete feedback button styles */
.feedback-item {
    position: relative;
    transition: all 0.3s ease;
}

.feedback-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.feedback-delete-btn {
    opacity: 0.7;
    transition: all 0.2s ease;
    padding: 4px 8px;
    font-size: 0.8rem;
}

.feedback-delete-btn:hover {
    opacity: 1;
    transform: scale(1.05);
    box-shadow: 0 2px 6px rgba(220, 53, 69, 0.3);
}

.feedback-delete-btn:active {
    transform: scale(0.95);
}

/* Fade out animation for deleted feedback */
@keyframes fadeOutSlide {
    0% {
        opacity: 1;
        transform: translateX(0);
    }
    100% {
        opacity: 0;
        transform: translateX(-20px);
    }
}

.feedback-deleting {
    animation: fadeOutSlide 0.3s ease-out forwards;
}
</style>

<div class="container">
    <!-- Content Header -->
    <div class="content-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-4 mb-3">{{ content.title }}</h1>
                <div class="d-flex flex-wrap">
                    <span class="meta-badge">{{ content.type if content.type else 'Unknown' }}</span>
                    <span class="meta-badge">{{ content.difficulty_level if content.difficulty_level else 'Unknown' }}</span>
                    <span class="meta-badge"><i class="fas fa-eye me-1"></i> {{ content.view_count or 0 }} views</span>
                </div>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <div class="rating-summary-card">
                    {% if content.average_rating %}
                        <div class="d-flex align-items-center justify-content-md-end">
                            <div class="text-center me-3">
                                <div class="rating-score">{{ "%.1f"|format(content.average_rating) }}</div>
                                <div class="rating-stars">
                                    {% for i in range(5) %}
                                        <i class="fas fa-star {% if i < content.average_rating|round|int %}text-warning{% else %}text-muted{% endif %}"></i>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="rating-details">
                                <div class="rating-count">{{ content.rating_count or 0 }}</div>
                                <small class="text-muted">ratings</small>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-star fa-2x mb-2"></i>
                            <div class="rating-count">0</div>
                            <small>No ratings yet</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Content Body -->
            <div class="content-body">
                {% if content.external_link %}
                    {# 优先显示外部链接资源，不管content.type是什么 #}
                    <div class="content-preview text-center">
                        {% if content.type == 'video' %}
                            <i class="fas fa-external-link-alt fa-5x text-info mb-3"></i>
                            <h4>External Video Resource</h4>
                            <p class="text-muted">This video is hosted on an external platform</p>
                        {% elif content.type == 'document' or content.type == 'pdf' %}
                            <i class="fas fa-external-link-alt fa-5x text-info mb-3"></i>
                            <h4>External Document Resource</h4>
                            <p class="text-muted">This document is hosted on an external platform</p>
                        {% elif content.type == 'presentation' %}
                            <i class="fas fa-external-link-alt fa-5x text-info mb-3"></i>
                            <h4>External Presentation Resource</h4>
                            <p class="text-muted">This presentation is hosted on an external platform</p>
                        {% else %}
                            <i class="fas fa-external-link-alt fa-5x text-info mb-3"></i>
                            <h4>External Resource</h4>
                            <p class="text-muted">This resource is hosted on an external platform</p>
                        {% endif %}
                        <a href="{{ content.external_link }}" class="btn btn-primary btn-lg mt-3" target="_blank">
                            <i class="fas fa-external-link-alt me-2"></i>Open Resource
                        </a>
                    </div>
                {% elif content.file_url %}
                    {# 基于实际文件扩展名预览或显示下载 #}
                    {% if content.file_url.lower().endswith(('.mp4', '.avi', '.mov', '.wmv', '.flv', '.webm', '.mkv')) %}
                        <div class="content-preview mb-4">
                            <div class="video-container">
                                <video controls preload="metadata" width="100%" style="max-height: 500px;">
                                    <source src="{{ content.file_url }}" type="video/mp4">
                                    <source src="{{ content.file_url }}" type="video/webm">
                                    <source src="{{ content.file_url }}" type="video/ogg">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                        </div>
                    {% elif content.file_url.lower().endswith(('.pdf')) %}
                        <div class="content-preview">
                            <div class="text-center mb-3">
                                <i class="fas fa-file-pdf fa-5x text-danger mb-3"></i>
                                <h4>PDF Document</h4>
                                <p class="text-muted">This PDF document needs to be downloaded to view</p>
                                <a href="{{ content.file_url }}" class="btn btn-primary btn-lg btn-custom" target="_blank" download>
                                    <i class="fas fa-download me-2"></i>Download PDF
                                </a>
                            </div>
                        </div>
                    {% elif content.file_url.lower().endswith(('.doc', '.docx')) %}
                        <div class="content-preview">
                            <div class="text-center mb-3">
                                <i class="fas fa-file-word fa-5x text-primary mb-3"></i>
                                <h4>Word Document</h4>
                                <p class="text-muted">This Word document needs to be downloaded to view</p>
                                <a href="{{ content.file_url }}" class="btn btn-primary btn-lg btn-custom" target="_blank" download>
                                    <i class="fas fa-download me-2"></i>Download Document
                                </a>
                            </div>
                        </div>
                    {% elif content.file_url.lower().endswith(('.txt', '.rtf')) %}
                        <div class="content-preview">
                            <div class="text-center mb-3">
                                <i class="fas fa-file-alt fa-5x text-info mb-3"></i>
                                <h4>Text Document</h4>
                                <p class="text-muted">This text document needs to be downloaded to view</p>
                                <a href="{{ content.file_url }}" class="btn btn-primary btn-lg btn-custom" target="_blank" download>
                                    <i class="fas fa-download me-2"></i>Download Document
                                </a>
                            </div>
                        </div>
                    {% elif content.file_url.lower().endswith(('.ppt', '.pptx')) %}
                        <div class="content-preview">
                            <div class="text-center mb-3">
                                <i class="fas fa-file-powerpoint fa-5x text-warning mb-3"></i>
                                <h4>PowerPoint Presentation</h4>
                                <p class="text-muted">This PowerPoint presentation needs to be downloaded to view</p>
                                <a href="{{ content.file_url }}" class="btn btn-primary btn-lg btn-custom" target="_blank" download>
                                    <i class="fas fa-download me-2"></i>Download Presentation
                                </a>
                            </div>
                        </div>
                    {% elif content.file_url.lower().endswith(('.odt')) %}
                        <div class="content-preview">
                            <div class="text-center mb-3">
                                <i class="fas fa-file-alt fa-5x text-secondary mb-3"></i>
                                <h4>OpenDocument Text</h4>
                                <p class="text-muted">This ODT document needs to be downloaded to view</p>
                                <a href="{{ content.file_url }}" class="btn btn-primary btn-lg btn-custom" target="_blank" download>
                                    <i class="fas fa-download me-2"></i>Download Document
                                </a>
                            </div>
                        </div>
                    {% elif content.file_url.lower().endswith(('.odp')) %}
                        <div class="content-preview">
                            <div class="text-center mb-3">
                                <i class="fas fa-file-powerpoint fa-5x text-secondary mb-3"></i>
                                <h4>OpenDocument Presentation</h4>
                                <p class="text-muted">This ODP presentation needs to be downloaded to view</p>
                                <a href="{{ content.file_url }}" class="btn btn-primary btn-lg btn-custom" target="_blank" download>
                                    <i class="fas fa-download me-2"></i>Download Presentation
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <div class="content-preview">
                            <div class="text-center mb-3">
                                <i class="fas fa-file fa-5x text-secondary mb-3"></i>
                                <h4>File</h4>
                                <p class="text-muted">This file needs to be downloaded to view</p>
                                <a href="{{ content.file_url }}" class="btn btn-primary btn-lg btn-custom" target="_blank" download>
                                    <i class="fas fa-download me-2"></i>Download File
                                </a>
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="content-preview text-center">
                        {% if content.type == 'video' %}
                            <i class="fas fa-video fa-5x text-secondary mb-3"></i>
                            <h4>Video</h4>
                        {% elif content.type == 'document' or content.type == 'pdf' %}
                            <i class="fas fa-file fa-5x text-secondary mb-3"></i>
                            <h4>Document</h4>
                        {% elif content.type == 'presentation' %}
                            <i class="fas fa-presentation fa-5x text-secondary mb-3"></i>
                            <h4>Presentation</h4>
                        {% else %}
                            <i class="fas fa-file fa-5x text-secondary mb-3"></i>
                            <h4>Resource</h4>
                        {% endif %}
                        <p class="text-muted">No file or link available</p>
                    </div>
                {% endif %}
                
                <div class="content-description mt-4">
                    <h5><i class="fas fa-info-circle me-2"></i>Description</h5>
                    <p class="lead">{{ content.description }}</p>
                </div>

                {% if content.file_url %}
                    <!-- Only show download button here for files that don't already have one in content-preview -->
                    <!-- Files that already have download buttons in preview: doc, docx, txt, rtf, ppt, pptx, odt, odp, and other files -->
                    {% if content.file_url.lower().endswith(('.mp4', '.avi', '.mov', '.wmv', '.flv', '.webm', '.mkv')) %}
                        <!-- Video files have preview player but no download button -->
                        <div class="text-center mt-4">
                            <a href="{{ content.file_url }}" class="btn btn-primary btn-lg btn-custom" target="_blank" download>
                                <i class="fas fa-download me-2"></i>Download Video
                            </a>
                        </div>
                    {% endif %}
                {% endif %}
            </div>

            <!-- Quick Actions -->
            <div class="quick-action-card">
                <h5 class="mb-3"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                <div class="quick-actions-container">
                    <button class="btn btn-outline-primary btn-custom" onclick="markAsViewed()">
                        <i class="fas fa-eye me-2"></i>Mark as Viewed
                    </button>
                    <button class="btn btn-outline-success btn-custom" onclick="markAsCompleted()">
                        <i class="fas fa-check me-2"></i>Mark as Completed
                    </button>
                    <button id="bookmarkBtn" class="btn btn-outline-warning btn-custom" onclick="toggleBookmark()">
                        {% if is_bookmarked %}
                            <i class="fas fa-bookmark-fill me-2"></i>Unbookmark
                        {% else %}
                            <i class="fas fa-bookmark me-2"></i>Bookmark
                        {% endif %}
                    </button>
                    <button class="btn btn-outline-info btn-custom" onclick="shareContent()">
                        <i class="fas fa-share me-2"></i>Share
                    </button>
                </div>
                
                <!-- Compact Rating Section -->
                <hr class="my-4">
                <div class="rating-widget">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="mb-1"><i class="fas fa-star me-2 text-warning"></i>{% if user_feedback %}Your Rating (Update){% else %}Rate this Content{% endif %}</h6>
                            {% if user_feedback %}
                                <div class="user-rating-display">
                                    {% for i in range(5) %}
                                        <i class="fas fa-star {% if i < user_feedback.rating %}text-warning{% else %}text-muted{% endif %}"></i>
                                    {% endfor %}
                                    <span class="ms-2 text-muted">{{ user_feedback.rating }}/5</span>
                                </div>
                            {% endif %}
                        </div>
                        <div class="rating-stars-large">
                            <div class="rating-hint mb-2" id="ratingHint">Click to rate this content</div>
                            {% for i in range(5, 0, -1) %}
                                <input type="radio" id="compactStar{{ i }}" name="compactRating" value="{{ i }}" class="d-none" {% if user_feedback and user_feedback.rating == i %}checked{% endif %}>
                                <label for="compactStar{{ i }}" class="rating-label" title="{{ i }} star{{ 's' if i != 1 else '' }}">
                                    <i class="fas fa-star rating-star compact-rating-star" data-rating="{{ i }}"></i>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="rating-form-group">
                        <textarea class="rating-comment-box" id="compactRatingComment" rows="2" placeholder="Share your thoughts (optional)...">{% if user_feedback and user_feedback.comment %}{{ user_feedback.comment }}{% endif %}</textarea>
                        <div class="rating-actions">
                            <button type="button" class="rating-submit-btn" onclick="submitCompactRating()">
                                <i class="fas fa-paper-plane me-2"></i>{% if user_feedback %}Update Rating{% else %}Submit Rating{% endif %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs mt-4" id="contentTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">Details</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab" aria-controls="reviews" aria-selected="false">All Reviews ({{ feedback_count }})</button>
                </li>
                {% if session.get('user_role') == 'admin' or (session.get('user_role') == 'instructor' and content.uploaded_by == session.get('user_id')) %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="management-tab" data-bs-toggle="tab" data-bs-target="#management" type="button" role="tab" aria-controls="management" aria-selected="false">Management</button>
                </li>
                {% endif %}
            </ul>

            <div class="tab-content">
                <!-- Details Tab -->
                <div class="tab-pane fade show active" id="details" role="tabpanel">
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h6><i class="fas fa-tag me-2"></i>Tags</h6>
                            {% set tags_list = content.tags|split_tags %}
                            {% if tags_list %}
                                {% for tag in tags_list %}
                                    <span class="badge badge-secondary mr-2">{{ tag }}</span>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">No tags specified</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-user me-2"></i>Uploader</h6>
                            <p>{{ uploader_name or 'Unknown' }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-calendar me-2"></i>Created</h6>
                            <p>{{ content.created_at|format_datetime('%Y-%m-%d') }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-layer-group me-2"></i>Category</h6>
                            <p>{{ content.category_name or 'Uncategorized' }}</p>
                        </div>
                    </div>
                </div>

                <!-- Reviews Tab -->
                <div class="tab-pane fade" id="reviews" role="tabpanel">
                    <div class="mt-4">
                        {% if feedback_list %}
                            {% for feedback in feedback_list %}
                            <div id="feedback-{{ feedback.id }}" class="feedback-item mb-3 p-3 border rounded">
                                <!-- Header with user info and controls -->
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="d-flex align-items-center">
                                        <h6 class="mb-0 me-3">{{ feedback.user_name }}</h6>
                                        <div class="rating">
                                            {% for i in range(1, 6) %}
                                                <i class="fas fa-star {% if i <= feedback.rating %}text-warning{% else %}text-muted{% endif %}"></i>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% if session.get('user_id') == feedback.user_id or session.get('user_role') == 'admin' %}
                                    <div class="feedback-actions">
                                        <button class="feedback-delete-btn" 
                                                onclick="deleteFeedback({{ feedback.id }})"
                                                title="Delete this review">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Comment content -->
                                {% if feedback.comment %}
                                <div class="feedback-content mb-2">
                                    <p class="mb-0 text-break">{{ feedback.comment }}</p>
                                </div>
                                {% endif %}
                                
                                <!-- Footer with timestamp -->
                                <div class="feedback-meta">
                                    <small class="text-muted">
                                        <i class="far fa-clock me-1"></i>
                                        {{ feedback.created_at|format_datetime('%Y-%m-%d %H:%M') or 'No timestamp' }}
                                    </small>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Reviews Yet</h5>
                                <p class="text-muted">Be the first to share your thoughts about this content!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Management Tab -->
                {% if session.get('user_role') == 'admin' or (session.get('user_role') == 'instructor' and content.uploaded_by == session.get('user_id')) %}
                <div class="tab-pane fade" id="management" role="tabpanel">
                    <div class="mt-4">
                        <h5><i class="fas fa-cog me-2"></i>Content Management</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <a href="{{ url_for('content.edit', content_id=content.id) }}" 
                                   class="btn btn-outline-primary btn-management w-100 h-100 d-flex align-items-center justify-content-center">
                                    <div class="text-center">
                                        <i class="fas fa-edit fa-2x mb-2 text-primary"></i>
                                        <div class="fw-bold">Edit Content</div>
                                        <small class="text-muted">Modify title, description, and settings</small>
                                    </div>
                                </a>
                            </div>
                            {% if session.get('user_role') == 'admin' %}
                            <div class="col-md-6">
                                <button class="btn btn-outline-danger btn-management w-100 h-100 d-flex align-items-center justify-content-center" 
                                        onclick="confirmDelete()" data-bs-toggle="tooltip" data-bs-placement="top" 
                                        title="Permanently delete this content and all related data">
                                    <div class="text-center">
                                        <i class="fas fa-trash-alt fa-2x mb-2 text-danger"></i>
                                        <div class="fw-bold">Delete Content</div>
                                        <small class="text-muted">Remove content permanently</small>
                                    </div>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mt-4 p-3 bg-light rounded">
                            <h6 class="text-muted mb-2">
                                <i class="fas fa-info-circle me-2"></i>Management Actions
                            </h6>
                            <div class="row text-center">
                                <div class="col-md-6">
                                    <small class="text-muted">
                                        <i class="fas fa-edit text-primary me-1"></i>
                                        Edit content details, tags, and categorization
                                    </small>
                                </div>
                                {% if session.get('user_role') == 'admin' %}
                                <div class="col-md-6">
                                    <small class="text-muted">
                                        <i class="fas fa-trash-alt text-danger me-1"></i>
                                        Delete content and all associated data
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
        </div> <!-- End of col-lg-8 -->


    </div> <!-- End of row -->

            <div class="col-lg-4">
            <!-- Stats Card -->
            <div class="stats-card">
                <h5 class="mb-4"><i class="fas fa-chart-bar me-2"></i>Content Stats</h5>
                
                <div class="stats-item">
                    <div class="stats-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">{{ content.view_count or 0 }}</h6>
                        <small class="text-muted">Total Views</small>
                    </div>
                </div>

                <div class="stats-item">
                    <div class="stats-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">{{ "%.1f"|format(content.average_rating) if content.average_rating else '0.0' }}</h6>
                        <small class="text-muted">Average Rating</small>
                    </div>
                </div>

                <div class="stats-item">
                    <div class="stats-icon">
                        <i class="fas fa-download"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">{{ content.download_count or 0 }}</h6>
                        <small class="text-muted">Downloads</small>
                    </div>
                </div>
            </div>

            <!-- Related Content -->
            {% if related_content %}
            <div class="stats-card">
                <h5 class="mb-4"><i class="fas fa-book-open me-2"></i>Related Content</h5>
                {% for item in related_content %}
                    <div class="mb-3 p-3 border rounded hover-shadow">
                        <h6 class="mb-1">{{ item.title }}</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge badge-info">{{ item.type }}</span>
                            <small class="text-muted">{{ item.view_count }} views</small>
                        </div>
                        <a href="{{ url_for('content.view', content_id=item.id) }}" class="btn btn-sm btn-outline-primary mt-2">
                            View Content
                        </a>
                    </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- User Activity -->
            {% if user_activity %}
            <div class="stats-card">
                <h5 class="mb-4"><i class="fas fa-history me-2"></i>Your Activity</h5>
                <div class="stats-item">
                    <div class="stats-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">{{ user_activity.activity_type.title() }}</h6>
                        <small class="text-muted">Status</small>
                    </div>
                </div>
                {% if user_activity.progress_percentage %}
                <div class="stats-item">
                    <div class="stats-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">{{ user_activity.progress_percentage }}%</h6>
                        <small class="text-muted">Progress</small>
                    </div>
                </div>
                {% endif %}
                {% if user_activity.time_spent_minutes %}
                <div class="stats-item">
                    <div class="stats-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">{{ user_activity.time_spent_minutes }} min</h6>
                        <small class="text-muted">Time Spent</small>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div> <!-- End of col-lg-4 -->
</div> <!-- End of container -->

<!-- Rating Modal -->
<div class="modal fade" id="rateModal" tabindex="-1" aria-labelledby="rateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rateModalLabel">Rate this Content</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="ratingForm">
                    <div class="form-group">
                        <label for="modalRating">Rating</label>
                        <div class="mb-3">
                            {% for i in range(5, 0, -1) %}
                                <input type="radio" id="modalStar{{ i }}" name="modalRating" value="{{ i }}" class="d-none">
                                <label for="modalStar{{ i }}" class="rating-label">
                                    <i class="fas fa-star rating-star modal-rating-star" data-rating="{{ i }}"></i>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="modalComment">Comment (Optional)</label>
                        <textarea class="form-control" id="modalComment" rows="3" placeholder="Share your thoughts about this content..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitModalRating()">
                    <i class="fas fa-paper-plane me-2"></i>Submit Rating
                </button>
            </div>
        </div> <!-- End of col-lg-4 -->
    </div> <!-- End of row -->
</div> <!-- End of container -->
{% endblock %}

{% block extra_js %}
<script>
function showNotification(message, type) {
    type = type || 'success';
    var alert = document.createElement('div');
    var bgColor = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#17a2b8';
    var borderColor = bgColor;
    
    alert.className = 'alert alert-' + type + ' alert-dismissible fade show position-fixed custom-notification';
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; border-left: 4px solid ' + borderColor + '; animation: slideIn 0.3s ease-out;';
    
    var icon = type === 'success' ? 
        '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>' :
        type === 'error' ? 
        '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>' :
        '<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>';
    
    alert.innerHTML = '<div style="display: flex; align-items: center; justify-content: space-between;"><div style="display: flex; align-items: center;"><svg style="width: 20px; height: 20px; margin-right: 8px; fill: ' + bgColor + ';" viewBox="0 0 20 20">' + icon + '</svg><span style="font-weight: 500;">' + message + '</span></div><button type="button" class="close" style="background: none; border: none; font-size: 18px; line-height: 1; opacity: 0.8; padding: 4px; margin-left: 12px; cursor: pointer; transition: opacity 0.2s;" onmouseover="this.style.opacity=\'1\'" onmouseout="this.style.opacity=\'0.8\'"><span style="font-family: sans-serif; font-weight: 300;">&times;</span></button></div>';
    
    // Add close button functionality
    alert.querySelector('.close').addEventListener('click', function() {
        alert.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(function() {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 300);
    });
    
    document.body.appendChild(alert);
    
    // Auto-remove after appropriate time
    var autoRemoveTime = type === 'success' ? 4000 : 5000;
    setTimeout(function() {
        if (alert.parentNode) {
            alert.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(function() {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 300);
        }
    }, autoRemoveTime);
}

function recordActivity(activityType) {
    fetch('/content/{{ content.id }}/activity', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            activity_type: activityType
        })
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            var messages = {
                'viewed': 'Marked as viewed!',
                'in_progress': 'Marked as in progress!',
                'completed': 'Marked as completed!',
                'bookmarked': 'Added to bookmarks!'
            };
            
            showNotification(messages[activityType], 'success');
            
            // Only reload page for activities other than 'viewed'
            if (activityType !== 'viewed') {
                setTimeout(function() {
                    location.reload();
                }, 1500);
            }
        } else {
            showNotification(data.error || 'Operation failed', 'error');
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        showNotification('Network error. Please try again.', 'warning');
    });
}

function markAsViewed() {
    recordActivity('viewed');
}

function markAsCompleted() {
    recordActivity('completed');
}

function toggleBookmark() {
    const bookmarkBtn = document.getElementById('bookmarkBtn');
    const contentId = {{ content.id }};
    
    // Show loading state
    bookmarkBtn.disabled = true;
    const originalHtml = bookmarkBtn.innerHTML;
    bookmarkBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    
    fetch(`/content/${contentId}/bookmark`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update button state
            if (data.is_bookmarked) {
                bookmarkBtn.className = 'btn btn-warning btn-custom';
                bookmarkBtn.innerHTML = '<i class="fas fa-bookmark-fill me-2"></i>Unbookmark';
            } else {
                bookmarkBtn.className = 'btn btn-outline-warning btn-custom';
                bookmarkBtn.innerHTML = '<i class="fas fa-bookmark me-2"></i>Bookmark';
            }
            showNotification(data.message, 'success');
        } else {
            showNotification(data.error || 'Failed to toggle bookmark', 'error');
        }
    })
    .catch(error => {
        console.error('Error toggling bookmark:', error);
        showNotification('Failed to toggle bookmark', 'error');
    })
    .finally(() => {
        bookmarkBtn.disabled = false;
    });
}

function shareContent() {
    if (navigator.share) {
        navigator.share({
            title: '{{ content.title }}',
            text: '{{ content.description[:100] }}...',
            url: window.location.href
        });
    } else {
        // Copy to clipboard
        navigator.clipboard.writeText(window.location.href);
        showNotification('Link copied to clipboard!', 'info');
    }
}

function submitCompactRating() {
    var rating = document.querySelector('input[name="compactRating"]:checked');
    var comment = document.getElementById('compactRatingComment') ? document.getElementById('compactRatingComment').value : '';
    
    if (!rating) {
        showNotification('Please select a rating', 'warning');
        return;
    }
    
    // Show loading state
    var submitBtn = event.target;
    var originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Submitting...';
    
    // Submit rating via AJAX
    fetch('/content/{{ content.id }}/rate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            rating: parseInt(rating.value),
            comment: comment
        })
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            var isUpdate = {% if user_feedback %}true{% else %}false{% endif %};
            var message = isUpdate ? 'Rating updated successfully!' : 'Rating submitted successfully!';
            showNotification(message, 'success');
            
            // Update the UI without full page reload
            setTimeout(function() {
                location.reload();
            }, 1000);
        } else {
            showNotification(data.error || 'Failed to submit rating', 'error');
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        showNotification('Network error. Please try again.', 'warning');
    })
    .finally(function() {
        // Restore button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

function submitMainRating() {
    var rating = document.querySelector('input[name="mainRating"]:checked');
    var comment = document.getElementById('mainRatingComment') ? document.getElementById('mainRatingComment').value : '';
    
    if (!rating) {
        showNotification('Please select a rating', 'warning');
        return;
    }
    
    // Show loading state
    var submitBtn = event.target;
    var originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
    
    // Submit rating via AJAX
    fetch('/content/{{ content.id }}/rate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            rating: parseInt(rating.value),
            comment: comment
        })
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            var isUpdate = {% if user_feedback %}true{% else %}false{% endif %};
            var message = isUpdate ? 'Rating updated successfully!' : 'Rating submitted successfully!';
            showNotification(message, 'success');
            
            // Update the UI without full page reload
            setTimeout(function() {
                location.reload();
            }, 1000);
        } else {
            showNotification(data.error || 'Failed to submit rating', 'error');
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        showNotification('Network error. Please try again.', 'warning');
    })
    .finally(function() {
        // Restore button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}



// Initialize tooltips and rating stars
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    // Initialize compact rating stars
    var compactStars = document.querySelectorAll('.compact-rating-star');
    
    // Initialize compact stars with current rating
    var compactCheckedRating = document.querySelector('input[name="compactRating"]:checked');
    var compactInitialRating = compactCheckedRating ? compactCheckedRating.value : 0;
    updateCompactStars(compactInitialRating);
    updateRatingHint(compactInitialRating);
    
    compactStars.forEach(function(star) {
        star.addEventListener('click', function() {
            var rating = this.dataset.rating;
            document.getElementById('compactStar' + rating).checked = true;
            updateCompactStars(rating);
        });
        
        star.addEventListener('mouseenter', function() {
            var rating = this.dataset.rating;
            updateCompactStars(rating);
            updateRatingHint(rating);
        });
    });
    
    var compactRatingContainer = document.querySelector('.rating-widget');
    if (compactRatingContainer) {
        compactRatingContainer.addEventListener('mouseleave', function() {
            var checked = document.querySelector('input[name="compactRating"]:checked');
            var rating = checked ? checked.value : 0;
            updateCompactStars(rating);
            updateRatingHint(rating);
        });
    }
    
    // No separate review rating initialization needed - unified in Quick Rate
    
    // Modal rating stars
    var modalStars = document.querySelectorAll('.modal-rating-star');
    modalStars.forEach(function(star) {
        star.addEventListener('click', function() {
            var rating = this.dataset.rating;
            document.getElementById('modalStar' + rating).checked = true;
            updateModalStars(rating);
        });
        
        star.addEventListener('mouseenter', function() {
            var rating = this.dataset.rating;
            updateModalStars(rating);
        });
    });
    
    // No automatic view notification - user must manually mark as viewed
    
    // Initialize long comment handling
    initializeLongComments();
});

function initializeLongComments() {
    var feedbackContents = document.querySelectorAll('.feedback-content');
    
    feedbackContents.forEach(function(content) {
        var paragraph = content.querySelector('p');
        if (!paragraph) return;
        
        // Check if content is long enough to need truncation
        var text = paragraph.textContent.trim();
        if (text.length > 200) { // Threshold for "long" comments
            // Add show-more class
            content.classList.add('show-more-btn');
            
            // Create toggle button
            var toggleBtn = document.createElement('button');
            toggleBtn.className = 'feedback-toggle-btn';
            toggleBtn.textContent = 'Show more';
            toggleBtn.type = 'button';
            
            toggleBtn.addEventListener('click', function() {
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    toggleBtn.textContent = 'Show more';
                    content.classList.add('show-more-btn');
                } else {
                    content.classList.add('expanded');
                    toggleBtn.textContent = 'Show less';
                    content.classList.remove('show-more-btn');
                }
            });
            
            content.appendChild(toggleBtn);
        }
    });
}

function updateStars(rating) {
    var stars = document.querySelectorAll('.rating-star:not(.modal-rating-star)');
    stars.forEach(function(star, index) {
        if (index >= 5 - rating) {
            star.classList.add('active');
        } else {
            star.classList.remove('active');
        }
    });
}



function updateCompactStars(rating) {
    var stars = document.querySelectorAll('.compact-rating-star');
    stars.forEach(function(star, index) {
        if (index >= 5 - rating) {
            star.style.color = '#ffc107';
            star.classList.add('active');
        } else {
            star.style.color = '#ddd';
            star.classList.remove('active');
        }
    });
}

function updateRatingHint(rating) {
    var hintElement = document.getElementById('ratingHint');
    if (!hintElement) return;
    
    var hints = {
        1: 'Poor - Not recommended',
        2: 'Fair - Below average',
        3: 'Good - Average content',
        4: 'Very Good - High quality',
        5: 'Excellent - Outstanding content'
    };
    
    if (rating > 0) {
        hintElement.textContent = hints[rating] + ' (' + rating + ' star' + (rating != 1 ? 's' : '') + ')';
        hintElement.style.color = '#ffc107';
    } else {
        hintElement.textContent = 'Click to rate this content';
        hintElement.style.color = '#6c757d';
    }
}

function updateModalStars(rating) {
    var stars = document.querySelectorAll('.modal-rating-star');
    stars.forEach(function(star, index) {
        if (index >= 5 - rating) {
            star.classList.add('active');
        } else {
            star.classList.remove('active');
        }
    });
}

function openRatingModal() {
    var modal = new bootstrap.Modal(document.getElementById('rateModal'));
    
    // Pre-fill modal with current rating and comment
    var currentRating = document.querySelector('input[name="rating"]:checked');
    var currentComment = document.getElementById('ratingComment').value;
    
    if (currentRating) {
        document.getElementById('modalStar' + currentRating.value).checked = true;
        updateModalStars(currentRating.value);
    }
    
    if (currentComment) {
        document.getElementById('modalComment').value = currentComment;
    }
    
    modal.show();
}

function submitModalRating() {
    var rating = document.querySelector('input[name="modalRating"]:checked');
    var comment = document.getElementById('modalComment').value;
    
    if (!rating) {
        showNotification('Please select a rating', 'warning');
        return;
    }
    
    // Show loading state
    var submitBtn = event.target;
    var originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
    
    // Submit rating via AJAX
    fetch('/content/{{ content.id }}/rate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            rating: parseInt(rating.value),
            comment: comment
        })
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            showNotification('Rating submitted successfully!', 'success');
            
            // Close modal
            var modal = bootstrap.Modal.getInstance(document.getElementById('rateModal'));
            modal.hide();
            
            // Update the UI without full page reload
            setTimeout(function() {
                location.reload();
            }, 1000);
        } else {
            showNotification(data.error || 'Failed to submit rating', 'error');
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        showNotification('Network error. Please try again.', 'warning');
    })
    .finally(function() {
        // Restore button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

function deleteFeedback(feedbackId) {
    // Show custom confirmation dialog
    showDeleteConfirmDialog(feedbackId);
}

function showDeleteConfirmDialog(feedbackId) {
    // Create modal overlay
    var modalHtml = `
        <div class="modal fade delete-confirm-modal" id="deleteConfirmModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Confirm Deletion
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h6 class="mt-3">Are you sure you want to delete this review?</h6>
                        <p class="text-muted mb-0">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                            <i class="fas fa-trash me-2"></i>Delete Review
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    var existingModal = document.getElementById('deleteConfirmModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    var modalElement = document.getElementById('deleteConfirmModal');
    var modal = new bootstrap.Modal(modalElement);
    
    // Handle confirm delete
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        modal.hide();
        performDelete(feedbackId);
    });
    
    // Clean up modal after hidden
    modalElement.addEventListener('hidden.bs.modal', function() {
        modalElement.remove();
    });
    
    modal.show();
}

function performDelete(feedbackId) {
    // Show loading state
    var feedbackElement = document.getElementById('feedback-' + feedbackId);
    var deleteBtn = document.querySelector(`#feedback-${feedbackId} .feedback-delete-btn`);
    var originalBtnContent = deleteBtn.innerHTML;
    
    feedbackElement.classList.add('deleting');
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    // Send delete request
    fetch('/content/{{ content.id }}/feedback/' + feedbackId + '/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            // Add deletion animation class
            feedbackElement.classList.add('deleting');
            
            setTimeout(function() {
                feedbackElement.remove();
                
                // Update feedback count in the tab title with animation
                var reviewsTab = document.getElementById('reviews-tab');
                var currentCount = parseInt(reviewsTab.textContent.match(/\d+/)[0]);
                var newCount = currentCount - 1;
                
                reviewsTab.classList.add('review-count-updated');
                reviewsTab.textContent = 'Reviews (' + newCount + ')';
                
                setTimeout(function() {
                    reviewsTab.classList.remove('review-count-updated');
                }, 600);
                
                // Update statistics if stats are displayed
                updateRatingStats();
                
                showNotification('Review deleted successfully', 'success');
            }, 500); // Match the CSS animation duration
        } else {
            showNotification(data.error || 'Failed to delete review', 'error');
            // Restore button state
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = originalBtnContent;
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        showNotification('Network error. Please try again.', 'warning');
        // Restore button state
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalBtnContent;
    });
}

function updateRatingStats() {
    // Reload the page to refresh rating statistics
    setTimeout(function() {
        location.reload();
    }, 1000);
}

function confirmDelete() {
    if (confirm('Are you sure you want to delete this content? This action cannot be undone.')) {
        // Show loading state
        var deleteBtn = event.target;
        var originalText = deleteBtn.innerHTML;
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';
        
        // Send delete request via AJAX
        fetch('/content/{{ content.id }}/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(function(response) {
            if (response.redirected) {
                // If server redirects, follow the redirect
                window.location.href = response.url;
                return;
            }
            return response.text();
        })
        .then(function(data) {
            // Check if response contains flash messages (indicates success)
            if (data.includes('alert-success') || data.includes('success')) {
                showNotification('Content deleted successfully!', 'success');
                setTimeout(function() {
                    window.location.href = '/content/browse';
                }, 1500);
            } else {
                showNotification('Failed to delete content', 'error');
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
            showNotification('Network error. Please try again.', 'warning');
        })
        .finally(function() {
            // Restore button state if no redirect
            if (!deleteBtn.disabled) {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalText;
            }
        });
    }
}
</script>
{% endblock %}